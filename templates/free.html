{% extends "base.html" %}

{% block title %}{{ t("free.title") }}{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='favourite.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='listing.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Search Bar -->
    <div class="search-container">
        <form action="{{ url_for('search') }}" method="GET" class="search-form">
            <input type="text" name="query" placeholder="{{ t('free.search_placeholder') }}" class="search-input form-control" id="searchInput">
            <button type="button" class="btn btn-success btn-search" id="clearButton">{{ t('free.clear') }}</button>
        </form>
    </div>

    <!-- Free Listings -->
    <div id="itemsContainer">
        <div class="listings-section">
            <div class="listings-header">
                <h2>{{ t('free.free_section') }}</h2>
                <div class="actions-row">
                    <a href="{{ url_for('report_user') }}"><button class="report-btn btn btn-danger">{{ t('borrow_free.report_user') }}</button></a>
                    <a href="{{ url_for('create_listing') }}" class="btn btn-danger btn-create" id="create-btn">{{ t('free.create_new_listing') }}</a>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-5 g-4">
                {% for listing in free_listings %}
                    {% if listing.username != username %}
                    <div class="col">
                        <div class="card listing-card" data-name="{{ (listing.title or t('free.no_title')) | lower }}" data-id="{{ listing.id }}">
                            <!-- User Info -->
                            <div class="user-info">
                                <i class="fas fa-user-circle"></i> {{ listing.username }}
                            </div>

                            <!-- Listing Link -->
                            <a href="{{ url_for('booking', listing_id=listing.id) }}" style="text-decoration: none; color: inherit;">
                                <img src="{{ url_for('static', filename=listing.photo) }}" class="card-img-top listing-image" alt="">
                                <div class="card-body">
                                    <h5 class="card-title">{{ listing.title or t('free.no_title') }}</h5>
                                    <p class="card-text">{{ listing.description or t('free.no_description') }}</p>
                                </div>
                            </a>

                            <!-- Favorite Icon -->
                            <div class="favorite-btn">
                                <i class="material-icons favorite-icon"
                                   {% if listing.id in favourited_listings %}
                                     style="font-size: 36px; color: red;"
                                   {% else %}
                                     style="font-size: 36px; color: black"
                                   {% endif %}
                                   data-id="{{ listing.id }}">
                                   favorite
                                </i>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                <p class="no-listings">{{ t('free.no_description') }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const clearButton = document.getElementById("clearButton");
    const itemsContainer = document.getElementById("itemsContainer");
    const items = Array.from(itemsContainer.getElementsByClassName("listing-card"));
    const favoriteIcons = document.querySelectorAll(".favorite-icon");

    const favoritedListings = {{ favourited_listings | tojson }};

    // Truncate description to 15 words
    document.querySelectorAll('.card-text').forEach(description => {
        let text = description.textContent.trim();
        let maxWords = 15;
        let words = text.split(/\s+/);
        if (words.length > maxWords) {
            description.textContent = words.slice(0, maxWords).join(" ") + "...";
        }
    });

    // Favorite toggle
    favoriteIcons.forEach(icon => {
        const listingId = icon.dataset.id;
        const isFavorited = favoritedListings.includes(parseInt(listingId));

        icon.textContent = isFavorited ? "favorite" : "favorite_border";
        icon.style.color = isFavorited ? "red" : "black";
        icon.classList.toggle("favorited", isFavorited);

        icon.addEventListener("click", () => {
            const action = icon.classList.contains("favorited") ? "remove" : "add";
            fetch(`/favorite/${listingId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action }),
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    icon.textContent = action === "add" ? "favorite" : "favorite_border";
                    icon.style.color = action === "add" ? "red" : "black";
                    icon.classList.toggle("favorited");
                }
            })
            .catch(console.error);
        });
    });

    // Search filter
    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        items.forEach(item => {
            const name = item.dataset.name || "";
            item.closest(".col").style.display = name.includes(query) ? "" : "none";
        });
    });

    // Clear search
    clearButton.addEventListener("click", () => {
        searchInput.value = "";
        items.forEach(item => item.closest(".col").style.display = "");
    });
});
</script>
{% endblock %}
