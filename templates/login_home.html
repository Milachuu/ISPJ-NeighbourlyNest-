{% extends "base.html" %}
{% block title %}{{ t("borrow_free.title") }}{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='favourite.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='listing.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Search Bar -->
  <div class="search-container">
    <form action="{{ url_for('search') }}" method="GET" class="search-form">
      <input type="text" name="query" placeholder="{{ t('borrow_free.search_placeholder') }}" class="search-input form-control" id="searchInput">
      <button type="button" class="btn btn-success btn-search" id="clearButton">{{ t('borrow_free.clear') }}</button>
    </form>
  </div>

  <div id="itemsContainer">
    <!-- Borrow Listings -->
    <div class="listings-section">
      <div class="listings-header">
        <h2>{{ t('borrow_free.borrow') }}</h2>
        <div class="actions-row">
          <a href="{{ url_for('report_user') }}"><button class="report-btn btn btn-danger">{{ t('borrow_free.report_user') }}</button></a>
          <a href="{{ url_for('create_listing') }}" class="btn btn-danger btn-create" id="create-btn">{{ t('borrow_free.create_new_listing') }}</a>
        </div>
      </div>
      <div class="row row-cols-1 row-cols-md-5 g-4">
        {% for borrow in borrow_listings %}
        {% if borrow[1] != username %}
        <div class="col">
          <div class="card listing-card" data-name="{{ (borrow[2] or t('borrow_free.no_title'))|lower }}">
            <div class="user-info">
              <i class="fas fa-user-circle"></i> {{ borrow[1] }}
            </div>
            <a href="{{ url_for('booking', listing_id=borrow[0]) }}" style="text-decoration: none; color: inherit;">
              <img src="{{ url_for('static', filename=borrow[8]) if borrow[8] else url_for('static', filename='uploads/placeholder.png') }}" class="card-img-top listing-image" alt="">
              <i class="far fa-bookmark bookmark-icon"></i>
              <div class="card-body">
                <h5 class="card-title">{{ borrow[2] or t('borrow_free.no_title') }}</h5>
                <p class="card-text">{{ borrow[3] or t('borrow_free.no_description') }}</p>
              </div>
            </a>

            <div class="favorite-btn">
              <i class="material-icons favorite-icon"
                 {% if borrow[0] in favourited_listings %}
                   style="font-size: 36px; color: red;"
                 {% else %}
                   style="font-size: 36px; color: black;"
                 {% endif %}
                 data-id="{{ borrow[0] }}">
                favorite
              </i>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Free Listings -->
    <div class="listings-section mt-4">
      <div class="listings-header">
        <h2>{{ t('borrow_free.free') }}</h2>
      </div>
      <div class="row row-cols-1 row-cols-md-5 g-4">
        {% for free in free_listings %}
        {% if free[1] != username %}
        <div class="col">
          <div class="card listing-card" data-name="{{ (free[2] or t('borrow_free.no_title'))|lower }}">
            <div class="user-info">
              <i class="fas fa-user-circle"></i> {{ free[1] }}
            </div>
            <a href="{{ url_for('booking', listing_id=free[0]) }}" style="text-decoration: none; color: inherit;">
              <img src="{{ url_for('static', filename=free[8]) if free[8] else url_for('static', filename='uploads/placeholder.png') }}" class="card-img-top listing-image" alt="">
              <i class="far fa-bookmark bookmark-icon"></i>
              <div class="card-body">
                <h5 class="card-title">{{ free[2] or t('borrow_free.no_title') }}</h5>
                <p class="card-text">{{ free[3] or t('borrow_free.no_description') }}</p>
              </div>
            </a>

            <div class="favorite-btn">
              <i class="material-icons favorite-icon"
                 {% if free[0] in favourited_listings %}
                   style="font-size: 36px; color: red;"
                 {% else %}
                   style="font-size: 36px; color: black;"
                 {% endif %}
                 data-id="{{ free[0] }}">
                favorite
              </i>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const clearButton = document.getElementById("clearButton");
    const itemsContainer = document.getElementById("itemsContainer");
    const items = Array.from(itemsContainer.getElementsByClassName("listing-card"));
    const favoriteIcons = document.querySelectorAll(".favorite-icon");
    const favourited = {{ favourited_listings | tojson }};

    favoriteIcons.forEach(icon => {
      const id = icon.dataset.id;
      const isFav = favourited.includes(parseInt(id));
      icon.textContent = isFav ? "favorite" : "favorite_border";
      icon.style.color = isFav ? "red" : "black";
      icon.classList.toggle("favorited", isFav);

      icon.addEventListener("click", () => {
        const action = icon.classList.contains("favorited") ? "remove" : "add";
        fetch(`/favorite/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            icon.textContent = action === "add" ? "favorite" : "favorite_border";
            icon.style.color = action === "add" ? "red" : "black";
            icon.classList.toggle("favorited");
          }
        }).catch(console.error);
      });
    });

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      items.forEach(item => {
        item.closest(".col").style.display = item.dataset.name.includes(q) ? "" : "none";
      });
    });
    clearButton.addEventListener("click", () => {
      searchInput.value = "";
      items.forEach(item => item.closest(".col").style.display = "");
    });
  })
</script>
{% endblock %}
